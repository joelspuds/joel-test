{% extends 'layouts/bulma-ufs.layout.njk' %}
{% set pageTitle = 'Resources and costs' + ' - UKRI Funding service' %}
{% set projectName = projectName if projectName %}
{% set allResourcesValues = allResourcesValues if allResourcesValues %}
{% set backLinkContents =  [{url:'/prototypes/multi-user-application2/', text:'Back to application'}] %}
{%  set  directlyIncurredCost = directlyIncurredCost if directlyIncurredCost %}
{%  set  directlyAllocatedCost = directlyAllocatedCost if directlyAllocatedCost %}
{%  set  indirectCost = indirectCost if indirectCost %}
{%  set  exceptionCost = exceptionCost if exceptionCost %}
{%  set  resourcesAndCostsIsComplete = resourcesAndCostsIsComplete if resourcesAndCostsIsComplete %}
{%  set  readOnly = readOnly if readOnly %}

{% block content %}

    {% call components.bulmaRow() %}
        {% call components.bulmaColumnAny(size='is-two-thirds') %}
            {{ components.captionHeading(text='Resources and costs', caption=projectName) }}
        {%- endcall %}
    {%- endcall %}

    {% if readOnly %}

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='is-full') %}

                {{ components.alerts(text='You are in read-only view and nothing can be edited', type='info')}}

            {%- endcall %}

        {%- endcall %}

    {% endif %}

    {% call components.bulmaRow() %}

        {% call components.bulmaColumnAny(size='is-8') %}

            <p class="govuk-body">Provide a summary of the top-level costs of your project. Ensure you input a number (even if it is a zero) in each box. A full break down of your costs will be required at the review stage.</p>

            <details class="govuk-details" data-module="govuk-details">
                <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text">Guidance on resources and cost</span>
                </summary>
                <div class="govuk-details__text">
                    <p class="govuk-body">You can apply for up to £30,000 for a period of up to two years, at full economic cost.</p>
                    <p class="govuk-body">Additional funding up to £15,000 is available to cover costs of any international activities or participants. UK costs must be accounted for within the initial £30,000 funding.</p>
                    <p class="govuk-body">Try to be as precise as possible about the costs your required to itemise in the table below</p>
                </div>
            </details>

        {%- endcall %}

    {%- endcall %}

    {% call components.form(action='/prototypes/multi-user-application2/resources-and-costs', method='POST',name='resourcesAndCosts') %}

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='column is-8') %}

                <div class="responsive-table">

                    <table class="govuk-table">

                        <thead>
                        <tr>
                            <th class="govuk-table__header">Cost type</th>
                            <th class="govuk-table__header govuk-table__header--numeric">Full economic<br>cost (£)</th>
                            <th class="govuk-table__header govuk-table__header--numeric">Funding <br>percentage (%)</th>
                            <th class="govuk-table__header govuk-table__header--numeric">Funding <br>applied for (£)</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle">Directly incurred</td>
                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                <div class="govuk-form-group u-space-y5">
                                    <label class="govuk-label govuk-visually-hidden" for="directlyIncurredCost">Directly incurred full economic costs</label>
                                    <input class="govuk-input govuk-input--width-5 u-align-right" id="directlyIncurredCost" type="number" name="directlyIncurredCost" value="{% if directlyIncurredCost %}{{ directlyIncurredCost }}{% else %}0{% endif %}" {% if readOnly %} disabled{% endif %}>
                                </div>
                            </td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric">80</td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric"><span id="incurredContribution">£0</span></td>
                        </tr>

                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle">Directly allocated</td>
                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                <div class="govuk-form-group u-space-y5">
                                    <label class="govuk-label govuk-visually-hidden" for="directlyAllocatedCost">Directly allocated full economic costs</label>
                                    <input class="govuk-input govuk-input--width-5 u-align-right" id="directlyAllocatedCost" type="number" name="directlyAllocatedCost" value="{% if directlyAllocatedCost %}{{ directlyAllocatedCost }}{% else %}0{% endif %}" {% if readOnly %}disabled{% endif %}>
                                </div>
                            </td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric">80</td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric"><span id="alllocatedContribution">£0</span></td>
                        </tr>

                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle">Indirect costs</td>
                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                <div class="govuk-form-group u-space-y5">
                                    <label class="govuk-label govuk-visually-hidden" for="indirectCost">Indirect full economic costs</label>
                                    <input class="govuk-input govuk-input--width-5 u-align-right" id="indirectCost" type="number" name="indirectCost" value="{% if indirectCost %}{{ indirectCost }}{% else %}0{% endif %}" {% if readOnly %}disabled{% endif %}>
                                </div>
                            </td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric">80</td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric"><span id="indirectContribution">£0</span></td>
                        </tr>

                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle">Exceptions</td>
                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                <div class="govuk-form-group u-space-y5">
                                    <label class="govuk-label govuk-visually-hidden" for="exceptionCost">Exceptional full economic costs</label>
                                    <input class="govuk-input govuk-input--width-5 u-align-right" id="exceptionCost" type="number" name="exceptionCost" value="{% if exceptionCost %}{{ exceptionCost }}{% else %}0{% endif %}" {% if readOnly %}disabled{% endif %}>
                                </div>
                            </td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric">100</td>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--numeric"><span id="exceptionsContribution">£0</span></td>
                        </tr>

                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--borderless u-pad-t20"><strong>Total cost</strong></td>
                            <td class="govuk-table__cell govuk-table__cell--numeric govuk-table__cell--borderless u-pad-t20"><strong><span id="totalCost">£0</span></strong></td>
                            <td class="" colspan="2">&nbsp;</td>
                        </tr>

                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--borderless"><strong>Contribution from applying organisation</strong></td>
                            <td class="govuk-table__cell govuk-table__cell--numeric govuk-table__cell--borderless"><strong><span id="totalContribution">£0</span></strong></td>
                            <td class="" colspan="2">&nbsp;</td>
                        </tr>
                        <tr>
                            <td colspan="2" class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--borderless"><hr class="section-break--table"></td>
                            <td class="" colspan="2">&nbsp;</td>
                        </tr>
                        <tr>
                            <td class="govuk-table__cell govuk-table__cell--middle govuk-table__cell--borderless"><strong>Total funding applied for</strong></td>
                            <td class="govuk-table__cell govuk-table__cell--numeric govuk-table__cell--borderless"><strong><span id="totalRequested">£0</span></strong></td>
                            <td class="" colspan="2">&nbsp;</td>
                        </tr>

                        </tbody>

                    </table>

                </div>

            {%- endcall %}

        {%- endcall %}

        {% call components.bulmaRow(extraClass='u-space-t30') %}

            {% call components.bulmaColumnAny(size='is-full') %}

                {% call components.formGroup() %}
                    <div class="application-item">
                        <div class="application-item__contents application-item__contents--mac">
                            <fieldset class="govuk-fieldset" aria-describedby="markAsComplete">
                                <legend class="govuk-fieldset__legend govuk-visually-hidden">
                                    <h3 class="govuk-fieldset__heading" id="">Mark as complete</h3>
                                </legend>
                                <div class="govuk-checkboxes">
                                    <div class="govuk-checkboxes__item">
                                        <input class="govuk-checkboxes__input" id="markAsComplete" name="isComplete" type="checkbox" {% if resourcesAndCostsIsComplete == 'on' %} checked{% endif %} {% if readOnly %} disabled{% endif %}>
                                        <label class="govuk-label govuk-checkboxes__label" for="markAsComplete">Mark as complete</label>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                {%- endcall %}

            {%- endcall %}

        {%- endcall %}

        {% call components.bulmaRow() %}
            {% call components.bulmaColumnAny(size='is-full') %}
                <div class="application-controls govuk-clearfix">
                    {{ components.button(text='Save and return', extraClass="application-controls__submit")}}
                </div>
            {%- endcall %}
        {%- endcall %}

    {%- endcall %}

{% endblock %}

{% block bodyScripts %}
    <script>
        Zepto(function($){
            console.log('zepto loaded');
            /*
                #directlyIncurredCost
                #directlyAllocatedCost
                #indirectCost
                #exceptionCost

                #totalContribution
                #totalRequested

            */
            $('#directlyIncurredCost, #directlyAllocatedCost, #indirectCost ,#exceptionCost').on('blur', function(event) {
                let directlyIncurredCost = parseInt($('#directlyIncurredCost').val(), 10);
                let directlyAllocatedCost = parseInt($('#directlyAllocatedCost').val(), 10);
                let indirectlCost = parseInt($('#indirectCost').val(), 10);
                let exceptionCost = parseInt($('#exceptionCost').val(), 10);
                let totalValue = directlyIncurredCost + directlyAllocatedCost + indirectlCost + exceptionCost;
                // let totalRequested =
                console.log(totalValue);

                /*
                #totalCost
                #totalContribution
                #totalRequested
                 */

                let incurredContribution = (directlyIncurredCost/100)*80;
                $('#incurredContribution').html('£'+parseFloat(incurredContribution).toFixed(0));

                let alllocatedContribution = (directlyAllocatedCost/100)*80;
                $('#alllocatedContribution').html('£'+parseFloat(alllocatedContribution).toFixed(0));

                let indirectContribution = (indirectlCost/100)*80;
                $('#indirectContribution').html('£'+parseFloat(indirectContribution).toFixed(0));

                let exceptionsContribution = (exceptionCost/100)*100;
                $('#exceptionsContribution').html('£'+parseFloat(exceptionsContribution).toFixed(0));


                let totalRequested = parseFloat((incurredContribution + alllocatedContribution + indirectContribution + exceptionsContribution)).toFixed(0);

                $('#totalContribution').html('£'+(totalValue-totalRequested));

                $('#totalCost').html('£'+totalValue);

                // $('#totalRequested').html('£'+parseFloat((incurredContribution + alllocatedContribution + indirectContribution + exceptionsContribution)).toFixed(0));

                $('#totalRequested').html('£'+totalRequested);

                event.preventDefault();

            });


            /*$('#directlyIncurredCost, #directlyAllocatedCost, #indirectCost ,#exceptionCost').on('load', function(event) {
                this.blur();
                console.log('blurring');
                event.preventDefault();
            });*/

            $('document').ready(function() {
                setTimeout(function() {
                    console.log('test');
                    $('#directlyIncurredCost').focus().blur();
                },150);
            });
        })

    </script>
{% endblock %}

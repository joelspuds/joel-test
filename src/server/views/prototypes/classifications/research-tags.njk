{% set showExternalNav = false %}
{% set activeNavItem = 'home' %}
{% set navArea = 'home' %}
{% set homeLink = '/prototypes/classifications/home' %}
{% set awardsLink = '#' %}
{% set applicationsLink = '/prototypes/classifications/applications' %}
{% set awardsLink = '#' %}
{% set reviewsLink = '#' %}
{% set hideAccountLinks = true %}
{% set altProfilePagelink = '#' %}
{% set hideUserMenu = false %}

{% set pageTitle = 'Research areas' %}

{% extends 'layouts/bulma-ufs.layout.njk' %}

{% set allData = allData if allData %}
{% set userName = allData.userName if allData.userName else 'Dareh Justice' %}
{% set prototypeData = prototypeData if prototypeData %}

{% set navType = 'admin' %}
{% set isAdminUser = true %}
{%  set loggedOut = false %}

{% set pageTitle = 'Research areas ' + GLOBAL_TAG_TITLE_SUFFIX %}
{% set backLinkContents =  [{url:'/prototypes/classifications/application-overview', text:'Back to Appliction overview'}] %}


{% block content %}

    {% call components.bulmaRow() %}
        {% call components.bulmaColumnAny(size='is-two-thirds') %}
            {{ components.captionHeading(text='Research areas', caption='APP420: ' + prototypeData.applicationTitle) }}

            {#<p>prototypeData.classificationSavedTags|length = {{ prototypeData.classificationSavedTags|length }}</p>
            <p>{{ prototypeData.classificationSavedTags }}</p>#}
        {%- endcall %}
    {%- endcall %}

    {% call components.form(action='#', method='POST',name='formResearchAreas') %}
    <section class="section" id="mainContent">
        <style>
            mark .highlight{
                /*background: yellow;
                color: black;*/
                font-weight: bold!important;
                /*background: #ffcc00;*/
                background: white!important;
            }
        </style>
        {% call components.bulmaRow() %}
            {% call components.bulmaColumnAny(size='is-8') %}
                <div class="findThings">

                    <p class="govuk-body-l">Start searching to find some research areas to add to this application.</p>

                    <div class="govuk-form-group govuk-form-group--search">
                        <style>
                           #search {
                                text-transform: lowercase;
                            }
                        </style>
                        <label class="govuk-label govuk-label--s" for="search">Find research areas</label>
                        <input class="govuk-input govuk-input--width-10 search__input" id="search" name="searchQuery" type="text" placeholder="" value="{{ prototypeData.searchQuery }}">
                        {#<a href="#" onClick="clearFilterText" class="govuk-link govuk-!-display-inline-block u-space-x20 u-space-y10">Clear filter text</a>#}
                        <button type="submit" name="tagSearch" class="search__submit" value="search">Search</button>

                    </div>
                </div>
            {%- endcall %}
        {%- endcall %}

            {% call components.bulmaRow() %}
                {% call components.bulmaColumnAny(size='is-8') %}

                    {% if prototypeData.haveSearchResults %}
                        <div class="tag-selecta">
                            Show:

                            <a href="#" class="govuk-link govuk-!-display-inline-block u-space-x10 typeSelecta" data-type="all" id="selectaAll">All ({{ prototypeData.countAll }})</a>
                            {% if prototypeData.countClassifications > 0 %}
                                <a href="#" class="govuk-link govuk-!-display-inline-block u-space-x10 typeSelecta" data-type="classification" id="selectaClassifications">Classifications ({{ prototypeData.countClassifications }})</a>
                            {% else %}
                                <span class="govuk-!-display-inline-block u-space-x10">Classifications (0)</span>
                            {% endif %}

                            {% if prototypeData.countRouting > 0 %}
                                <a href="#" class="govuk-link govuk-!-display-inline-block u-space-x10 typeSelecta" data-type="routing" id="selectaRouting">Routing ({{ prototypeData.countRouting }})</a>
                            {% else %}
                                <span class="govuk-!-display-inline-block u-space-x10">Routing (0)</span>
                            {% endif %}

                            {% if prototypeData.countQualifiers > 0 %}
                                <a href="#" class="govuk-link govuk-!-display-inline-block u-space-x10 typeSelecta" data-type="qualifier" id="selectaQualifiers">Qualifiers ({{ prototypeData.countQualifiers }})</a>
                            {% else %}
                                <span class="govuk-!-display-inline-block u-space-x10">Qualifiers (0)</span>
                            {% endif %}

                            {% if prototypeData.countReporting > 0 %}
                                <a href="#" class="govuk-link govuk-!-display-inline-block u-space-x10 typeSelecta" data-type="reporting" id="selectaReporting">Reporting tags ({{ prototypeData.countReporting }})</a>
                            {% else %}
                                <span class="govuk-!-display-inline-block u-space-x10">Reporting tags (0)</span>
                            {% endif %}
                        </div>

                        <style>
                            .govuk-link--selected {
                                background: #ffdd00;
                                color: #000!important
                            }
                        </style>

                        <div class="responsive-table">
                            <table class="govuk-table responsive-table__table context selectaTable">
                                <thead>
                                <tr class="govuk-table__header">
                                    <th class="govuk-table__header">Tag</th>
                                    <th class="govuk-table__header"><span class="govuk-visually-hidden">Action</span></th>
                                </tr>
                                </thead>
                                <tbody>

                                {#  CLASSIFICATIONS LOOP #}
                                {% for classifications in resultsArrayClassifications %}
                                    <tr class="classificationItem">
                                        {% if classifications.t == "(null)" %}
                                            <td class="govuk-table__cell">
                                                {{ classifications.a }} &gt; {{ classifications.s }}
                                                <span class="govuk-!-display-block meta">(Classification)</span>
                                            </td>
                                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                                <a href="#" class="govuk-link tagShifter" data-type="classification" data-value="{{ classifications.a }} {{ classifications.s }} {{ classifications.t }}">Add <span class="govuk-visually-hidden">this item to my list of research areas</span></a>
                                            </td>
                                        {% else %}
                                            <td class="govuk-table__cell">
                                                {{ classifications.a }} &gt; {{ classifications.s }} > {{ classifications.t }}
                                                <span class="govuk-!-display-block meta">(Classification)</span>
                                            </td>
                                            <td class="govuk-table__cell govuk-table__cell--numeric">
                                                <a href="#" class="govuk-link tagShifter" data-type="classification" data-value="{{ classifications.a }} {{ classifications.s }} {{ classifications.t }}">Add <span class="govuk-visually-hidden">this item to my list of research areas</span></a>
                                            </td>
                                        {% endif %}

                                    </tr>
                                {% endfor %}


                                {#  ROUTING LOOP #}
                                {% for routes in resultsArrayRouting %}
                                    <tr class="routingItem">
                                        <td class="govuk-table__cell">
                                            {{ routes.name }}
                                            <span class="govuk-!-display-block meta">(Routing - {{ routes.council }})</span>
                                        </td>
                                        <td class="govuk-table__cell govuk-table__cell--numeric">
                                            <a href="#" class="govuk-link tagShifter" data-type="routing" data-value="{{ routes.name }}">Add <span class="govuk-visually-hidden">this item to my list of research areas</span></a>
                                        </td>
                                    </tr>
                                {% endfor %}

                                {#  QUALIFIERS LOOP #}
                                {% for qualifier in resultsArrayQualifiers %}
                                    <tr class="qualifierItem">
                                        <td class="govuk-table__cell">
                                            {{ qualifier }}
                                            <span class="govuk-!-display-block meta">(Qualifiers)</span>
                                        </td>
                                        <td class="govuk-table__cell govuk-table__cell--numeric">
                                            <a href="#" class="govuk-link tagShifter" data-type="qualifier" data-value="{{ qualifier }}">Add <span class="govuk-visually-hidden">this item to my list of research areas</span></a>
                                        </td>
                                    </tr>
                                {% endfor %}

                                {#  REPORTING LOOP #}
                                {% for reporting in resultsArrayReporting %}
                                    <tr class="reportingItem">
                                        <td class="govuk-table__cell">
                                            {{ reporting }}
                                            <span class="govuk-!-display-block meta">(Reporting tags)</span>
                                        </td>
                                        <td class="govuk-table__cell govuk-table__cell--numeric">
                                            <a href="#" class="govuk-link tagShifter" data-type="reporting" data-value="{{ reporting }}">Add <span class="govuk-visually-hidden">this item to my list of research areas</span></a>
                                        </td>
                                    </tr>
                                {% endfor %}

                                </tbody>
                            </table>
                        </div>



                    {% else %}
                        <p class="govuk-body">Use the search to find research areas.</p>
                    {% endif %}

                {%- endcall %}

                {% call components.bulmaColumnAny(size='is-3 is-offset-1') %}
                    <div class="govuk-related-items govuk-related-items--flush ">
                        <style>
                            .tags-input {
                                border:none;
                                font-size:16px;
                                width:100%;
                            }
                        </style>
                        <h2 class="govuk-heading-s u-space-y5">Selected research areas</h2>
                        <p class="govuk-body-s u-space-b5" id="noTagsMessage">No research areas have been added</p>
                        <div class="tags-input govuk-visually-hidden u-space-t10" id="tagsExist">

                            <h3 class="govuk-heading-xs">Classifications</h3>
                            <button class="govuk-button--link govuk-!-font-size-16" name="weightings" value="weightings">Add classification weightings</button>
                            <ol class="govuk-list govuk-list--number u-space-t10" data-container="classification">
                            </ol>

                            <h3 class="govuk-heading-xs">Routing</h3>
                            <ol class="govuk-list govuk-list--number u-space-t10" data-container="routing">
                            </ol>

                            <h3 class="govuk-heading-xs">Qualifiers</h3>
                            {% if prototypeData.qualifierSavedTags|length <= 0 %}
                                <p class="meta u-space-b10">None selected</p>
                            {% else %}
                                <ol class="govuk-list govuk-list--number u-space-t10" data-container="qualifier">
                                </ol>
                            {% endif %}

                            <h3 class="govuk-heading-xs">Reporting tags</h3>
                            <ol class="govuk-list govuk-list--number u-space-t10" data-container="reporting">
                            </ol>

                        </div>
                        {#{% if prototypeData.someAreasExist %}
                            <ul class="govuk-list u-space-t10">
                                <li>

                                </li>
                            </ul>
                        {% else %}
                            <p class="govuk-body-s u-space-b5">No research areas have been added</p>
                        {% endif %}#}
                    </div>
                {%- endcall %}

            {%- endcall %}

            {#{% call components.bulmaRow() %}

                {% call components.bulmaColumnAny(size='is-8') %}

                    {% call components.formGroup() %}
                        <div class="application-item">
                            <div class="application-item__contents application-item__contents--mac">
                                <fieldset class="govuk-fieldset" aria-describedby="markAsComplete">
                                    <legend class="govuk-fieldset__legend govuk-visually-hidden">
                                        <h3 class="govuk-fieldset__heading" id="">Mark as complete</h3>
                                    </legend>
                                    <div class="govuk-checkboxes">
                                        <div class="govuk-checkboxes__item">
                                            <input class="govuk-checkboxes__input" id="markAsComplete" name="isComplete" type="checkbox" {% if prototypeData.caseMarkAsComplete %} checked{% endif %}  >
                                            <label class="govuk-label govuk-checkboxes__label" for="markAsComplete">Mark as complete</label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    {%- endcall %}

                {%- endcall %}

            {%- endcall %}#}

            {% call components.bulmaRow() %}

                {% call components.bulmaColumnAny(size='is-8') %}

                    {% call components.formGroup() %}
                        <div class="application-controls govuk-clearfix">
                            {% if prototypeData.caseMarkAsComplete %}
                                <a href="/prototypes/editv2/application-overview-2" class="govuk-link">Return to application overview</a>
                            {% else %}
                                {#{{ components.button(text='Save and return', name='saveAndReturn', extraClass="application-controls__submit")}}#}

                                <button class="govuk-button application-controls__submit" type="submit" name='saveAndReturn' value="saveAndReturn">Save and return</button>

                            {% endif %}
                        </div>
                    {%- endcall %}

                {%- endcall %}

            {%- endcall %}



    </section>
    {%- endcall %} {# end form #}


    {% include '../../layouts/partials/user-contact.njk' %}

{% endblock %}




{% block bodyScripts %}
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script>
        // tagShifter
        // data-type="classification | routing | qualifier"
        // data-value
        // classification1 | routing1 | qualifier1
        $( document ).ready(function() {
            console.log( "ready!" );

            /*let classificationIndex = 0;
            let routingIndex = 0;
            let qualifierIndex = 0;
            let reportingIndex = 0;*/

            {#{{ prototypeData.classificationSavedTags }}
            {{ prototypeData.routingSavedTags }}
            {{ prototypeData.qualifierSavedTags }}
            {{ prototypeData.reportingSavedTags }}#}

            let classificationItems = [];
            {% if prototypeData.classificationSavedTags|length > 1 %}
                {% set tempString = '' %}
                {% for item in prototypeData.classificationSavedTags %}
                    {% set tempString = tempString + '"' + item.tag + '",' %}
                {% endfor %}
                {% set tempString = '[' + tempString + ']' %}
                classificationItems = {{ tempString }}
                displayArrays('classification');
            {% endif %}

            let routingItems = [];
            {% if prototypeData.routingSavedTags|length > 1 %}
                {% set tempString = '' %}
                {% for item in prototypeData.routingSavedTags %}
                    {% set tempString = tempString + '"' + item + '",' %}
                {% endfor %}
                {% set tempString = '[' + tempString + ']' %}
                    routingItems = {{ tempString }}
                displayArrays('routing');
            {% endif %}

            let qualifierItems = [];
            {% if prototypeData.qualifierSavedTags|length > 1 %}
                {% set tempString = '' %}
                {% for item in prototypeData.qualifierSavedTags %}
                    {% set tempString = tempString + '"' + item + '",' %}
                {% endfor %}
                {% set tempString = '[' + tempString + ']' %}
                qualifierItems = {{ tempString }}
                displayArrays('qualifier');
            {% endif %}

            let reportingItems = [];
            {% if prototypeData.reportingSavedTags|length > 1 %}
                {% set tempString = '' %}
                {% for item in prototypeData.reportingSavedTags %}
                    {% set tempString = tempString + '"' + item + '",' %}
                {% endfor %}
                {% set tempString = '[' + tempString + ']' %}
                reportingItems = {{ tempString }}
                displayArrays('reporting');
            {% endif %}

            function displayArrays(arrayInQuestion) {
                //console.log('arrayInQuestion = ' + arrayInQuestion);
                $('#noTagsMessage').addClass('govuk-visually-hidden');
                $('#tagsExist').removeClass('govuk-visually-hidden');
                let tempHTMLString = '';
                for(let i = 0; i < eval(arrayInQuestion + "Items").length; i++) {
                    tempHTMLString += '<li class="ra-items"><input type="hidden" class="tags-input" id="' + arrayInQuestion + 'Hidden' + i + '" name="' + arrayInQuestion + i + '" value="' + eval(arrayInQuestion + "Items")[i] + '">' + '<span id="' + arrayInQuestion + 'Visible' + i + '" class="">' + eval(arrayInQuestion + "Items")[i] + '</span> <a class="govuk-link itemRemover" href="#" data-item="' + eval(arrayInQuestion + "Items")[i] + '" data-array="' + arrayInQuestion +'" data-index="'+i+'">Remove<span> item from this list</span></a></li>';

                };

                $('ol[data-container=' + arrayInQuestion + ']').html(tempHTMLString).removeClass('govuk-visually-hidden');
            };

            $('body').on('click', '.itemRemover', function(e) {
                console.log('bah!');
                e.preventDefault();
                let thisArray = $(this).attr('data-array');
                let thisIndex = $(this).attr('data-index');
                console.log('thisArray = ' + thisArray + ', thisIndex = ' + thisIndex);
                // let thisValue = $(this).attr('data-item');
                eval(thisArray + "Items").splice(thisIndex,1);
                displayArrays(thisArray);
            });

            $('.tagShifter').each(function(index){
                $(this).on('click', function(e){
                    e.preventDefault();
                    let thisType = $(this).attr('data-type');
                    let thisValue = $(this).attr('data-value');
                    //console.log('thisType = ' + thisType + ' thisValue = ' + thisValue);

                    let relevantArray = eval(thisType + "Items");
                    //console.log('relevantArray = ' + relevantArray);

                    if(eval(thisType + "Items").includes(thisValue)) {
                        console.log('already exists in array');
                    } else {
                        if(eval(thisType + "Items").length < 5) {
                            eval(thisType + "Items").push(thisValue);
                        } else {
                            console.log('This array is full');
                        }
                    }

                    displayArrays(thisType);

                    console.log(classificationItems);
                    console.log(routingItems);
                    console.log(qualifierItems);
                    console.log(reportingItems);
                });
            });






            $('.typeSelecta').each(function(index){
                $(this).on('click', function(e){
                    e.preventDefault();
                    let typeToShow = $(this).attr('data-type');
                    console.log('typeToShow = ' + typeToShow);

                    $('.typeSelecta').removeClass('govuk-link--selected');
                    $(this).addClass('govuk-link--selected');

                    if(typeToShow !== 'all') {
                        $('.selectaTable tbody tr').css('display', 'none');
                        $('tr.'+typeToShow+'Item').css('cssText', 'display: table-row!important;');
                    } else {
                        $('.selectaTable tbody tr').css('display', 'table-row');
                    }
                });
            });
        });

    </script>


    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.js"></script>
    <script>
        let markInstance = new Mark(document.querySelector('.context'));
        function performMark() {
            var keyword = '{{ prototypeData.searchQuery }}';
            console.log('keyword = ' + keyword);
            markInstance.unmark({
                done: function () {
                    markInstance.mark(keyword);
                },
            });
            markInstance.mark('{{ prototypeData.searchQuery }}', {
                "element": "span",
                "className": "highlight"
            });
        };
        window.addEventListener('load', performMark);
    </script>
{% endblock %}


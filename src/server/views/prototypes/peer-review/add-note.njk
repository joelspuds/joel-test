{% extends 'layouts/bulma-ufs.layout.njk' %}
{% set navType = 'admin' %}
{% set isAdminUser = true %}
{% set pageTitle = 'Add note'  + GLOBAL_TAG_TITLE_SUFFIX %}
{% set backLinkContents =  [{url:'/prototypes/peer-review/application-overview', text:'Back to appliction overview'}] %}

{% set personID = personID if personID %}
{% set personName = personName if personName %}
{% set userNote = userNote if userNote %}
{% set linkOrigin = linkOrigin if linkOrigin %}

{% block content %}

    {% call components.form(action='#', method='POST',name='addNote') %}

        {% call components.bulmaRow(extraClass='') %}
            {% call components.bulmaColumnAny(size='is-two-thirds') %}
            {% set newTitle = personName + ' - notes' %}
                {{ components.captionHeading(text=newTitle, caption='Name of the application') }}
            {%- endcall %}
        {%- endcall %}

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='is-8') %}

                <div class="govuk-character-count" data-module="govuk-character-count" data-maxlength="200">
                    <div class="govuk-form-group ">
                        <label class="govuk-label govuk-label--s govuk-!-font-weight-bold" for="userNote">Internal notes (optional)</label>
                        <div class="govuk-hint">Add any information that you want to share in the box below.</div>
                        <textarea class="govuk-textarea govuk-js-character-count" name="userNote" id="userNote" rows="8" {% if readOnly %} disabled {% endif %}>{{ userNote }}</textarea>
                        {#<p class="govuk-body u-space-t20"><span id="wordCount" class="govuk-hint govuk-character-count__message" aria-live="polite">You have 250 words remaining</span></p>#}
                    </div>
                </div>

            {%- endcall %}

        {%- endcall %}


        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='is-full') %}

                <div class="application-controls govuk-clearfix">
                    <input type="hidden" value="{{ linkOrigin }}" name="notesOrigin">
                    {{ components.button(text='Save notes', extraClass="application-controls__submit")}}

                    <span class="sub-button">
                        {% if linkOrigin === 'v2' %}
                            {{ components.link(text='Cancel', url='/prototypes/peer-review/application-overview-2')}}
                        {% else %}
                            {{ components.link(text='Cancel', url='/prototypes/peer-review/application-overview')}}
                        {% endif %}
                    </span>
                </div>

            {%- endcall %}

        {%- endcall %}


    {%- endcall %}

{% endblock %}

{% block bodyScripts %}
    <script src="https://cdn.tiny.cloud/1/phk3goz7y02jvj65em0m21azcq1qr7abduimch9isoe4jkor/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        const counteroutputFoot = document.getElementById('wordCount');
        let words = 0;
        const limit = 250;
        let tinyMCEWordCount;

        tinymce.init({
            selector: '#userNote',
            height: 240,
            {% if readOnly %} readonly : 1, {% endif %}
            plugins: [
                'advlist autolink lists link  anchor',
                'wordcount'
            ],
            setup: function(editor) {

                editor.on('keyup', function(e) {
                    tinyMCEWordCount = parseInt(document.getElementsByClassName('tox-statusbar__wordcount')[0].innerHTML.split([' ']));
                    console.log('tinyMCEWordCount = ' + tinyMCEWordCount);
                    words = tinyMCEWordCount;
                    let remainder = limit - words;
                    if (words < limit) {
                        counteroutputFoot.innerHTML = 'You have ' + remainder + ' words remaining';
                    } else {
                        let overCount = words - limit;
                        counteroutputFoot.innerHTML = '<span style="font-weight:700;color:red">You have ' +  overCount + ' words too many</span>';
                    }
                });

                editor.on('init', function(e) {
                    setTimeout(function(){
                        tinyMCEWordCount = parseInt(document.getElementsByClassName('tox-statusbar__wordcount')[0].innerHTML.split([' ']));
                        console.log('tinyMCEWordCount = ' + tinyMCEWordCount);
                        words = tinyMCEWordCount;
                        let remainder = limit - words;
                        counteroutputFoot.innerHTML = 'You have ' + remainder + ' words remaining';
                    }, 500);
                });
            },
            toolbar: 'formatselect | bold italic | bullist numlist | align | indent outdent | link | table |',
            content_css: [
                '//fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i',
                '/stylesheets/tinymce.css'
            ],
            menubar: false,
        });
    </script>
{% endblock %}

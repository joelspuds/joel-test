{% extends 'layouts/bulma-ufs.layout.njk' %}
{% set navType = 'admin' %}
{% set pageTitle = 'Expert review' + GLOBAL_TAG_TITLE_SUFFIX %}
{% set backLinkContents =  [{url:'/prototypes/peer-review/opportunity-setup', text:'Back to Opportunity set-up'}] %}
{% set isAdminUser = true %}

{% set workflowReviewItemAdded = workflowReviewItemAdded if workflowReviewItemAdded %}

{% set guidance = guidance if guidance %}
{% set expertReviewIsComplete = expertReviewIsComplete if expertReviewIsComplete %}
{% set wordCount = wordCount if wordCount %}

{% block content %}

    {% call components.bulmaRow() %}

        {% call components.bulmaColumnAny(size='is-full') %}

            {{ components.captionHeading(text='Expert review', caption='The name of my Opportunity') }}

        {%- endcall %}

    {%- endcall %}

    {% call components.form(action='#', method='POST', name='expertReview') %}

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='is-8', customID='mainContent') %}

                {#{{ components.captionHeading(text='Expert review guidance', tag='h2', size='m') }}

                <p class="govuk-body"> Your review will be checked for usability. If suitable, it will be forwarded to the applicant to respond to any feedback you provide. Your review and the applicant's response will be sent to panel for consideration.</p>#}

                {#<div class="govuk-form-group">
                    <h3 class="govuk-label-wrapper">
                        <label class="govuk-label govuk-label--s" for="more-detail">Guidelines for writing a expert review</label>
                    </h3>
                    <div id="guidance" class="govuk-hint">
                        These guideline will be available to the reviewer when writing their review
                    </div>
                    <textarea class="govuk-textarea" id="guidance" name="guidance" rows="5" aria-describedby="more-detail-hint">{{ guidance }}</textarea>
                </div>#}


                <div class="govuk-character-count" data-module="govuk-character-count" data-maxlength="200">
                    <div class="govuk-form-group ">
                        <label class="govuk-label govuk-label--s govuk-!-font-weight-bold" for="guidance">Guidelines for writing an expert review</label>
                        <div class="govuk-hint">Add any guidance that helps the reviewer complete their analysis and write up of the the application and produce a usable review.</div>
                        <textarea class="govuk-textarea govuk-js-character-count" name="guidance" id="guidance" rows="8" {% if readOnly %} disabled {% endif %}>{{ guidance }}</textarea>
                        {#<p class="govuk-body u-space-t20"><span id="wordCount" class="govuk-hint govuk-character-count__message" aria-live="polite">You have 250 words remaining</span></p>#}
                    </div>
                </div>

                {{ components.linkHeading(text='Expert review word count', tag='h3', size='s')}}

                <details class="govuk-details u-space-t20" data-module="govuk-details" role="group">
                    <summary class="govuk-details__summary" role="button" aria-controls="details-content-0" aria-expanded="false">
                        <span class="govuk-details__summary-text">Guidance to setting a word count limit</span>
                    </summary>
                    <div class="govuk-details__text" id="details-content-0" aria-hidden="true">
                        <p class="govuk-body">
                            {#Roughly allow 400 words for each section of the application being reviewed. Try to keep the total under 2,000 words.#}
                            The review should be no more that 2000 words in total unless there are special circumstances depending on the Opportunity.
                        </p>

                    </div>
                </details>

                <div class="govuk-form-group">
                    <h3 class="govuk-label-wrapper">
                        <label class="govuk-label govuk-label--s" for="wordCount">Word count limit</label>
                    </h3>
                    <input class="govuk-input govuk-input--width-4" id="wordCount" name="wordCount" type="text" spellcheck="false" aria-describedby="account-number-hint" pattern="[0-9]*" inputmode="numeric" formnovalidate value="{{ wordCount }}">
                </div>

                <section class="section" id="submitSection">
                    {% call components.formGroup() %}
                        <div class="application-item">
                            <div class="application-item__contents">
                                <fieldset class="govuk-fieldset" aria-describedby="markAsComplete">
                                    <legend class="govuk-fieldset__legend govuk-visually-hidden">
                                        <h3 class="govuk-fieldset__heading" id="">Mark as complete</h3>
                                    </legend>
                                    <div class="govuk-checkboxes">
                                        <div class="govuk-checkboxes__item">
                                            <input class="govuk-checkboxes__input" id="markAsComplete" name="isComplete" type="checkbox" {% if expertReviewIsComplete %} checked{% endif %}>
                                            <label class="govuk-label govuk-checkboxes__label" for="markAsComplete">Mark as complete</label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    {%- endcall %}

                    {% call components.formGroup() %}

                        {{ components.button(text='Save and return', extraClass="application-controls__submit")}}

                    {%- endcall %}

                </section>


            {%- endcall %}

        {%- endcall %}

    {%- endcall %}

{% endblock %}
{% block bodyScripts %}
    <script src="https://cdn.tiny.cloud/1/phk3goz7y02jvj65em0m21azcq1qr7abduimch9isoe4jkor/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        const counteroutputFoot = document.getElementById('wordCount');
        let words = 0;
        const limit = 250;
        let tinyMCEWordCount;

        tinymce.init({
            selector: '#guidance',
            height: 240,
            {% if readOnly %} readonly : 1, {% endif %}
            plugins: [
                'advlist autolink lists link  anchor'
            ],
            setup: function(editor) {

                editor.on('keyup', function(e) {
                    tinyMCEWordCount = parseInt(document.getElementsByClassName('tox-statusbar__wordcount')[0].innerHTML.split([' ']));
                    console.log('tinyMCEWordCount = ' + tinyMCEWordCount);
                    words = tinyMCEWordCount;
                    let remainder = limit - words;
                    if (words < limit) {
                        counteroutputFoot.innerHTML = 'You have ' + remainder + ' words remaining';
                    } else {
                        let overCount = words - limit;
                        counteroutputFoot.innerHTML = '<span style="font-weight:700;color:red">You have ' +  overCount + ' words too many</span>';
                    }
                });

                editor.on('init', function(e) {
                    setTimeout(function(){
                        tinyMCEWordCount = parseInt(document.getElementsByClassName('tox-statusbar__wordcount')[0].innerHTML.split([' ']));
                        console.log('tinyMCEWordCount = ' + tinyMCEWordCount);
                        words = tinyMCEWordCount;
                        let remainder = limit - words;
                        counteroutputFoot.innerHTML = 'You have ' + remainder + ' words remaining';
                    }, 500);
                });
            },
            toolbar: 'formatselect | bold italic | bullist numlist | align | indent outdent | link | table |',
            content_css: [
                '//fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i',
                '/stylesheets/tinymce.css'
            ],
            menubar: false,
        });
    </script>
{% endblock %}

{% set isAdminUser = false %}
{%  set loggedOut = false %}
{% extends 'layouts/bulma-ufs.layout.njk' %}

{% set pageTitle = 'Spreadsheet example' %}
{#{% set showSpreadsheetscripts = true %}#}

{% block content %}

    {% call components.bulmaRow() %}
        {% call components.bulmaColumnAny(size='is-two-thirds') %}
            {{ components.captionHeading(text='Spreadsheet example') }}
        {%- endcall %}
    {%- endcall %}

    <section class="section" id="mainContent">

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='column is-9-desktop is-9-widescreen') %}
                {#{{ components.paragraph(text='Enter your financial data into the spreadsheet below. You can cut and paste directly from an Excel spreadsheet. Paste into', size='l')}}#}

                <p class="govuk-body">
                    {{ components.link(text='Download example data', url='/files/example_spreadsheeet3.xls')}}
                </p>

                {#{{ components.paragraph(text='Select the required cells in Excel and paste into the "spreadsheet" below, then click the <strong>Munge data</strong> button. Contents will be displayed in a JavaScript alert dialogue or open the console (Right click > inspect) to view the captured data as a big array. This data can very easily be sent off to a the server and manipulated programatically.')}}#}

                {{ components.paragraph(text='Select the required cells from any of the tables in the spreadsheet linked above and paste into cell A1 below, then click the <strong>Munge data</strong> button. Contents will be displayed in a table on the following page.')}}

            {%- endcall %}

        {%- endcall %}

        {% call components.bulmaRow() %}

            {% call components.bulmaColumnAny(size='column is-full {#is-9-desktop is-9-widescreen#}') %}

                {% call components.form(action='#', method='POST',name='formSpreadsheet') %}

                    <div id="financialData"></div>

                    <input type="hidden" id="dataHolder" name="dataHolder">
                    <input type="hidden" id="colCount" name="colCount">

                    <noscript>
                        <div class="govuk-warning-text">
                            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                            <strong class="govuk-warning-text__text">
                                <span class="govuk-warning-text__assistive">Warning</span>
                                You have JavaScript disabled in your browser settings
                            </strong>
                        </div>
                        <p class="govuk-body">You have JavaScript turned off and it is required to use this feature. If you can not enable JavaScript, then email your spreadsheet to <a href="mailto:financialdata@ukri.org">financialdata@ukri.org</a> and ensure that you include the name of the Opportunity and your application reference number.</p>
                        {#<div class="govuk-form-group">
                            <h1 class="govuk-label-wrapper"><label class="govuk-label govuk-label--l" for="more-detail">
                                    Can you provide more detail?
                                </label>
                            </h1>
                            <div id="more-detail-hint" class="govuk-hint">
                                Do not include personal or financial information, like your National Insurance number or credit card details.
                            </div>
                            <textarea class="govuk-textarea" id="more-detail" name="more-detail" rows="5" aria-describedby="more-detail-hint"></textarea>
                        </div>#}
                    </noscript>

                    <div class="application-controls govuk-clearfix u-space-t45">

                        <button type="submit" id="saveTableData" class="govuk-button application-controls__submit">Munge data</button>

                    </div>

                {%- endcall %}

            {%- endcall %}

        {%- endcall %}

    </section>

{% endblock %}


{% block bodyScripts %}
    {# remote #}
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" media="all" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js'></script>
    {# local #}
    {#<link href="/stylesheets/handsontable.full.min.css" media="all" rel="stylesheet">
    <script src='/javascripts/handsontable.full.min.js'></script>#}
    <script>
        var ready = (callback) => {
            if (document.readyState != 'loading') callback();
            else document.addEventListener('DOMContentLoaded', callback);
        }
        ready(() => {
            let data = [
                ['',''],
                ['','']
            ];

            let container = document.getElementById('financialData');
            let hot = new Handsontable(container, {
                data: data,
                rowHeaders: true,
                colHeaders: true,
                filters: false,
                dropdownMenu: false,
                licenseKey: 'non-commercial-and-evaluation',
                width: 'auto',
                copyPaste: true,
                afterChange: function(changes, source) {
                    // console.log(source);
                    if (source  == 'CopyPaste.paste') {
                        changes.forEach((cell) => {
                            let thisCell = cell;
                            console.log(thisCell);
                            if (cell[3].includes(',')) {
                                cell[3] = cell[3].replace(/[,]/g, '');
                                var instance = this.getInstance();
                                instance.setDataAtCell(cell[0],cell[1],cell[3].trim());
                            }
                        });

                    }
                }
            });
            // console.log(hot.countCols());
            let saveButton = document.getElementById('saveTableData');
            let dataHolder = document.getElementById('dataHolder');
            let colCount = document.getElementById('colCount');
            let theForm = document.getElementsByTagName('form')[0];
            saveButton.onclick = function(e) {
                e.preventDefault();
                dataHolder.value = data;
                colCount.value = hot.countCols();
                theForm.submit();
            };
        });
    </script>
{% endblock %}
